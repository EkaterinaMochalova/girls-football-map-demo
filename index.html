<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Карта девичьего футбола — демо</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

  <style>
    html, body { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; }
    #app { height: 100%; display: flex; flex-direction: column; }

    #topbar{
      padding: 12px 14px; border-bottom: 1px solid #eee;
      display: flex; gap: 12px; align-items: center; flex-wrap: wrap;
      background: #fff;
    }

    .kpi { background: #f6f7f9; border: 1px solid #eee; border-radius: 12px; padding: 10px 12px; min-width: 140px; }
    .kpi .v { font-weight: 700; font-size: 18px; }
    .kpi .t { color: #666; font-size: 12px; margin-top: 2px; }

    #map { flex: 1; min-height: 420px; }

    .legend{
      position:absolute; bottom:16px; left:16px; z-index:999;
      background:#fff; border:1px solid #eee; border-radius:12px; padding:10px 12px;
      box-shadow:0 10px 30px rgba(0,0,0,0.08);
      font-size:12px;
    }
    .legend .row{ display:flex; align-items:center; gap:8px; margin:6px 0; }
    .swatch{ width:14px; height:14px; border-radius:4px; border:1px solid rgba(0,0,0,0.15); }

    .popup h3 { margin: 0 0 6px 0; font-size: 15px; }
    .popup .muted { color: #666; font-size: 12px; margin-bottom: 6px; }

    /* Chip (checkbox filter) */
    .chip{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid #eee;
      border-radius:12px;
      background:#fff;
      user-select:none;
      cursor:pointer;
      transition: box-shadow .15s ease, border-color .15s ease, transform .05s ease;
    }
    .chip:hover{ border-color:#e6e6e6; box-shadow:0 8px 22px rgba(0,0,0,0.06); }
    .chip:active{ transform: translateY(1px); }
    .chip input{ transform: scale(1.05); }
    .chip img{ width:26px; height:26px; object-fit:contain; }
    .chip span{ font-weight:600; }
    .chip small{ color:#666; }

    /* Visible error panel */
    #err{
      position:fixed;
      right:16px;
      bottom:16px;
      max-width:520px;
      white-space:pre-wrap;
      background: rgba(15, 15, 15, 0.92);
      color:#fff;
      padding:12px 14px;
      border-radius:12px;
      font-size:12px;
      line-height:1.35;
      z-index:9999;
      display:none;
    }
    #err strong{ display:block; margin-bottom:6px; }
  </style>
</head>

<body>
<div id="app">
  <div id="topbar">
    <div class="kpi"><div class="v" id="kpiRegions">—</div><div class="t">регионов в GeoJSON</div></div>
    <div class="kpi"><div class="v" id="kpiSchools">—</div><div class="t">школ (точек)</div></div>
    <div class="kpi"><div class="v" id="kpiGirls">—</div><div class="t">девочек (в сумме)</div></div>
    <div class="kpi"><div class="v" id="kpiSchoolsWithGirls">—</div><div class="t">школ с девочками</div></div>

    <!-- Toggles control ONLY highlighting -->
    <label class="chip" title="Подсветить регионы Суперлиги (клубы всегда видны в попапе региона)">
      <input type="checkbox" id="toggleSuperleague" />
      <img src="./assets/superleague_logo.png" alt="Суперлига" />
      <span>Суперлига</span>
      <small id="slStatus">(…)</small>
    </label>

    <label class="chip" title="Подсветить регионы Первой лиги (клубы всегда видны в попапе региона)">
      <input type="checkbox" id="toggleFirstLeague" />
      <img src="./assets/firstleague_logo_orange.png" alt="Первая лига" />
      <span>Первая лига</span>
      <small id="flStatus">(…)</small>
    </label>
  </div>

  <div id="map"></div>
</div>

<div id="err"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
(function () {
  const errBox = document.getElementById('err');
  function showErr(title, msg) {
    console.error(title, msg);
    errBox.style.display = 'block';
    errBox.innerHTML = `<strong>${title}</strong>${String(msg || '')}`;
  }

  window.addEventListener('error', (e) => showErr('JS ошибка', e.message || e.error || e));
  window.addEventListener('unhandledrejection', (e) => showErr('Promise ошибка', e.reason || e));

  if (typeof L === 'undefined') {
    showErr('Leaflet не загрузился', 'Проверь доступ к https://unpkg.com (возможно блокировка).');
    return;
  }

  // Map init
  const map = L.map('map', { preferCanvas: true }).setView([61.5, 96.5], 3);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  const fmt = new Intl.NumberFormat('ru-RU');

  function normRegion(s) {
    if (!s) return "";
    return String(s)
      .toLowerCase()
      .replaceAll("ё", "е")
      .replace(/[().,"]/g, " ")
      .replace(/\s+/g, " ")
      .trim()
      .replace(/\b(республика|область|край|автономная область|автономный округ|округ|г\.|город)\b/g, "")
      .replace(/\s+/g, " ")
      .trim();
  }

  function colorFor(value, breaks) {
    if (value == null) return '#f3f4f6';
    if (value <= breaks[0]) return '#eff6ff';
    if (value <= breaks[1]) return '#dbeafe';
    if (value <= breaks[2]) return '#bfdbfe';
    if (value <= breaks[3]) return '#93c5fd';
    if (value <= breaks[4]) return '#60a5fa';
    return '#3b82f6';
  }

  function styleFill(feature) {
    const girls = feature.properties?.total_girls ?? 0;
    const fill = colorFor(girls, [0, 50, 150, 300, 700]);
    return {
      weight: 1,
      color: 'rgba(0,0,0,0.25)',
      fillColor: fill,
      fillOpacity: 0.55
    };
  }

  function regionBaseHTML(p) {
    const schools = p.total_schools ?? 0;
    const schoolsWithGirls = p.schools_with_girls ?? 0;
    const girls = p.total_girls ?? 0;
    const avg = p.avg_girls_per_school ?? 0;
    return `
      <div class="popup">
        <h3>${p.name ?? 'Регион'}</h3>
        <div class="muted">Сводка по спортшколам 2024</div>
        <div><b>Школ:</b> ${fmt.format(schools)}</div>
        <div><b>Школ с девочками:</b> ${fmt.format(schoolsWithGirls)}</div>
        <div><b>Девочек:</b> ${fmt.format(girls)}</div>
        <div><b>Среднее на школу:</b> ${fmt.format(Math.round(avg*10)/10)}</div>
      </div>
    `;
  }

  async function fetchJSON(url) {
    const res = await fetch(url + '?v=' + Date.now());
    const text = await res.text();
    if (!res.ok) throw new Error(`HTTP ${res.status} при загрузке ${url}\n${text.slice(0,200)}`);
    try { return JSON.parse(text); }
    catch (e) { throw new Error(`Не могу распарсить JSON: ${url}\n${e}\n${text.slice(0,200)}`); }
  }

  const cluster = L.markerClusterGroup({
    chunkedLoading: true,
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false
  });

  const superCheckbox = document.getElementById('toggleSuperleague');
  const firstCheckbox = document.getElementById('toggleFirstLeague');
  const slStatus = document.getElementById('slStatus');
  const flStatus = document.getElementById('flStatus');

  // Data holders
  let regionsData = null;
  let pointsData = null;

  let regionsFillLayer = null;   // interactive layer (popups)
  let superOutlineLayer = null;  // non-interactive outline layer
  let firstOutlineLayer = null;  // non-interactive outline layer

  // Competitions data
  let superBrand = { color: "#d000e0", colorDark: "#501070", logo: "./assets/superleague_logo.png" };
  let firstBrand = { color: "#ff4b00", colorDark: "#111111", logo: "./assets/firstleague_logo_orange.png" };

  let superByRegion = {}; // normalized -> array of strings
  let firstByRegion = {}; // normalized -> array of {club,city} or strings

  function renderClubLines(items) {
    return (items || []).map(x => {
      if (typeof x === "string") return `• ${x}`;
      const club = x.club || "Клуб";
      const city = x.city ? ` (${x.city})` : "";
      return `• ${club}${city}`;
    }).join("<br>");
  }

  function buildRegionPopup(p) {
    const base = regionBaseHTML(p);
    const key = normRegion(p.name);

    const sl = superByRegion[key] || [];
    const fl = firstByRegion[key] || [];

    let extra = "";

    if (sl.length > 0) {
      extra += `
        <div style="margin-top:10px; padding-top:10px; border-top:1px solid #eee;">
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
            <img src="${superBrand.logo}" alt="Суперлига" style="width:18px; height:18px; object-fit:contain;">
            <b style="color:${superBrand.color}">Суперлига</b>
          </div>
          <div style="margin-top:4px; line-height:1.35;">
            ${renderClubLines(sl)}
          </div>
        </div>
      `;
    }

    if (fl.length > 0) {
      extra += `
        <div style="margin-top:10px; padding-top:10px; border-top:1px solid #eee;">
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
            <img src="${firstBrand.logo}" alt="Первая лига" style="width:18px; height:18px; object-fit:contain;">
            <b style="color:${firstBrand.color}">Первая лига</b>
          </div>
          <div style="margin-top:4px; line-height:1.35;">
            ${renderClubLines(fl)}
          </div>
        </div>
      `;
    }

    return extra ? base.replace("</div>", extra + "</div>") : base;
  }

  function updateAllRegionPopups() {
    if (!regionsFillLayer) return;
    regionsFillLayer.eachLayer(layer => {
      const p = layer.feature?.properties || {};
      layer.bindPopup(buildRegionPopup(p), { maxWidth: 360 });
    });
  }

  function computeMatchedStatus(byRegionObj, statusEl) {
    if (!statusEl || !regionsFillLayer) return;
    const geoRegions = new Set();
    regionsFillLayer.eachLayer(l => {
      const p = l.feature?.properties || {};
      geoRegions.add(normRegion(p.name));
    });
    const keys = Object.keys(byRegionObj);
    const matched = keys.filter(k => geoRegions.has(k)).length;
    statusEl.textContent = `(регионов: ${keys.length}, совпало: ${matched})`;
  }

  function rebuildOutlines() {
    if (!regionsData) return;

    // remove old
    if (superOutlineLayer) map.removeLayer(superOutlineLayer);
    if (firstOutlineLayer) map.removeLayer(firstOutlineLayer);
    superOutlineLayer = null;
    firstOutlineLayer = null;

    // build new super outline if toggled
    if (superCheckbox?.checked) {
      superOutlineLayer = L.geoJSON(regionsData, {
        interactive: false,
        style: (feature) => {
          const key = normRegion(feature?.properties?.name);
          const has = (superByRegion[key] || []).length > 0;
          if (!has) return { opacity: 0, fillOpacity: 0 };
          return {
            color: superBrand.color,
            weight: 3,
            opacity: 1,
            fillOpacity: 0
          };
        }
      }).addTo(map);
      // keep outlines above fill
      superOutlineLayer.bringToFront();
    }

    // build first league outline if toggled (dashed orange)
    if (firstCheckbox?.checked) {
      firstOutlineLayer = L.geoJSON(regionsData, {
        interactive: false,
        style: (feature) => {
          const key = normRegion(feature?.properties?.name);
          const has = (firstByRegion[key] || []).length > 0;
          if (!has) return { opacity: 0, fillOpacity: 0 };
          return {
            color: firstBrand.color,
            weight: 3,
            opacity: 1,
            dashArray: "7 5",
            lineCap: "round",
            lineJoin: "round",
            fillOpacity: 0
          };
        }
      }).addTo(map);
      firstOutlineLayer.bringToFront();
    }

    // ensure fill is under outlines but still clickable
    if (regionsFillLayer) regionsFillLayer.bringToBack();
  }

  // MAIN LOAD
  Promise.all([
    fetchJSON('./russia_subjects_with_sportschools2024.json'),
    fetchJSON('./schools_points.json')
  ])
  .then(([regions, points]) => {
    regionsData = regions;
    pointsData = points;

    // KPI
    const totalRegions = regions.features?.length ?? 0;
    const sumGirls = (regions.features || []).reduce((a,f)=>a + (f.properties?.total_girls ?? 0), 0);
    const sumSchools = (regions.features || []).reduce((a,f)=>a + (f.properties?.total_schools ?? 0), 0);
    const sumSchoolsWithGirls = (regions.features || []).reduce((a,f)=>a + (f.properties?.schools_with_girls ?? 0), 0);

    document.getElementById('kpiRegions').textContent = fmt.format(totalRegions);
    document.getElementById('kpiGirls').textContent = fmt.format(sumGirls);
    document.getElementById('kpiSchools').textContent = fmt.format(points.features?.length ?? sumSchools);
    document.getElementById('kpiSchoolsWithGirls').textContent = fmt.format(sumSchoolsWithGirls);

    // Regions fill (interactive)
    regionsFillLayer = L.geoJSON(regions, {
      style: styleFill,
      onEachFeature: (feature, layer) => {
        const p = feature.properties || {};
        layer.bindPopup(regionBaseHTML(p), { maxWidth: 360 });

        layer.on('mouseover', () => layer.setStyle({ weight: 2 }));
        layer.on('mouseout', () => layer.setStyle({ weight: 1 }));
      }
    }).addTo(map);

    // Points (schools)
    const pointsLayer = L.geoJSON(points, {
      pointToLayer: (feature, latlng) => L.circleMarker(latlng, {
        radius: 6,
        weight: 1,
        fillOpacity: 0.75
      }),
      onEachFeature: (feature, layer) => {
        const p = feature.properties || {};
        const html = `
          <div class="popup">
            <h3>${p.name ?? "Без названия"}</h3>
            <div class="muted">${p.region ?? ""}${p.city ? ", " + p.city : ""}</div>
            <div>${p.address ?? ""}</div>
            <div style="margin-top:8px;"><b>Девочек:</b> ${fmt.format(p.girls_total ?? 0)}</div>
            ${p.phone ? `<div><b>Тел:</b> ${p.phone}</div>` : ""}
            ${p.email ? `<div><b>Email:</b> ${p.email}</div>` : ""}
          </div>
        `;
        layer.bindPopup(html, { maxWidth: 360 });
      }
    });

    cluster.addLayer(pointsLayer);
    map.addLayer(cluster);

    map.fitBounds(regionsFillLayer.getBounds().pad(0.1));

    // Legend
    const legend = L.control({position: 'bottomleft'});
    legend.onAdd = function() {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <div style="font-weight:700; margin-bottom:6px;">Заливка: девочек в регионе</div>
        <div class="row"><span class="swatch" style="background:#eff6ff"></span> 0</div>
        <div class="row"><span class="swatch" style="background:#dbeafe"></span> 1–50</div>
        <div class="row"><span class="swatch" style="background:#bfdbfe"></span> 51–150</div>
        <div class="row"><span class="swatch" style="background:#93c5fd"></span> 151–300</div>
        <div class="row"><span class="swatch" style="background:#60a5fa"></span> 301–700</div>
        <div class="row"><span class="swatch" style="background:#3b82f6"></span> 701+</div>
      `;
      return div;
    };
    legend.addTo(map);

    // Load competitions (popups ALWAYS show; checkboxes ONLY highlight)
    return Promise.all([
      fetchJSON('./data/superleague_clubs.json').catch(e => { console.error("Superleague data failed:", e); if (slStatus) slStatus.textContent = "(ошибка)"; return null; }),
      fetchJSON('./data/firstleague_clubs_v1.json').catch(e => { console.error("First league data failed:", e); if (flStatus) flStatus.textContent = "(ошибка)"; return null; })
    ]);
  })
  .then(([sl, fl]) => {
    // Superleague
    if (sl) {
      superBrand = sl.brand || superBrand;
      superByRegion = {};
      const src = sl.by_region || {};
      for (const [rName, clubs] of Object.entries(src)) {
        superByRegion[normRegion(rName)] = (clubs || []).filter(Boolean);
      }
      computeMatchedStatus(superByRegion, slStatus);
    } else {
      if (slStatus) slStatus.textContent = "(нет данных)";
    }

    // First league
    if (fl) {
      firstBrand = fl.brand || firstBrand;
      firstByRegion = {};
      const src = fl.by_region || {};
      for (const [rName, clubs] of Object.entries(src)) {
        firstByRegion[normRegion(rName)] = (clubs || []).filter(Boolean);
      }
      computeMatchedStatus(firstByRegion, flStatus);
    } else {
      if (flStatus) flStatus.textContent = "(нет данных)";
    }

    // Now that we have competitions data, upgrade popups everywhere
    updateAllRegionPopups();

    // Outlines depend on toggles
    rebuildOutlines();

    superCheckbox?.addEventListener('change', rebuildOutlines);
    firstCheckbox?.addEventListener('change', rebuildOutlines);

    // Hide error box if all good
    errBox.style.display = 'none';
  })
  .catch(err => {
    showErr('Ошибка загрузки данных', err);
  });

})();
</script>
</body>
</html>
