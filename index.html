<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Карта девичьего футбола — демо</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

  <style>
    :root{
      --bg: #f6f7fb;
      --card: rgba(255,255,255,0.65);
      --card-strong: rgba(255,255,255,0.78);
      --stroke: rgba(0,0,0,0.08);
      --stroke-strong: rgba(0,0,0,0.12);
      --shadow: 0 18px 45px rgba(0,0,0,0.12);
      --shadow-soft: 0 10px 30px rgba(0,0,0,0.08);
      --text: rgba(20,20,25,0.92);
      --muted: rgba(20,20,25,0.55);
      --radius-lg: 18px;
      --radius-md: 14px;
      --blur: 18px;
    }

    html, body { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; color: var(--text); background: var(--bg); }

    body:before{
      content:"";
      position: fixed; inset: 0;
      background:
        radial-gradient(900px 500px at 20% -10%, rgba(255,75,0,0.12), transparent 55%),
        radial-gradient(700px 450px at 90% 10%, rgba(208,0,224,0.12), transparent 55%),
        radial-gradient(900px 600px at 40% 120%, rgba(59,130,246,0.14), transparent 60%);
      pointer-events:none;
      z-index:0;
    }

    #app { height: 100%; display: grid; grid-template-columns: 340px 1fr; grid-template-rows: 1fr 280px; gap: 14px; padding: 14px; position: relative; z-index: 1; }

    /* Left glass panel */
    #sidebar{
      grid-column: 1; grid-row: 1 / span 2;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    #sidebarHeader{
      padding: 14px 14px 10px 14px;
      border-bottom: 1px solid var(--stroke);
      background: linear-gradient(to bottom, rgba(255,255,255,0.76), rgba(255,255,255,0.60));
    }

    .title{
      font-weight: 800;
      letter-spacing: -0.02em;
      font-size: 16px;
      line-height: 1.1;
    }
    .subtitle{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    #kpis{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      padding: 12px 14px 14px 14px;
      border-bottom: 1px solid var(--stroke);
    }
    .kpi{
      background: rgba(255,255,255,0.6);
      border: 1px solid var(--stroke);
      border-radius: 14px;
      padding: 10px 10px;
      box-shadow: var(--shadow-soft);
    }
    .kpi .v{ font-weight: 800; font-size: 18px; letter-spacing:-0.02em; }
    .kpi .t{ margin-top: 2px; font-size: 11px; color: var(--muted); }

    #filters{
      padding: 12px 14px 14px 14px;
      overflow: auto;
      min-height: 0;
    }

    .section{
      margin-bottom: 14px;
      padding-bottom: 14px;
      border-bottom: 1px solid var(--stroke);
    }
    .section:last-child{ border-bottom: none; padding-bottom: 0; margin-bottom: 0; }

    .section h4{
      margin: 0 0 10px 0;
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .chip{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border: 1px solid var(--stroke);
      border-radius: 14px;
      background: rgba(255,255,255,0.65);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow-soft);
      user-select:none;
      cursor:pointer;
      transition: background .15s ease, border-color .15s ease, transform .05s ease;
      margin-bottom: 10px;
    }
    .chip:hover{ background: rgba(255,255,255,0.78); border-color: var(--stroke-strong); }
    .chip:active{ transform: translateY(1px); }
    .chip input{ transform: scale(1.05); }
    .chip img{ width: 24px; height: 24px; object-fit: contain; }
    .chip span{ font-weight: 700; font-size: 13px; }
    .chip small{ margin-left: auto; color: var(--muted); font-size: 12px; }

    .select{
      width: 100%;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.62);
      border-radius: 14px;
      padding: 10px 10px;
      font-size: 13px;
      outline: none;
      box-shadow: var(--shadow-soft);
    }

    .hint{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .rangeWrap{
      background: rgba(255,255,255,0.55);
      border: 1px solid var(--stroke);
      border-radius: 14px;
      padding: 10px 10px;
      box-shadow: var(--shadow-soft);
    }
    .rangeWrap .labelLine{
      display:flex; justify-content: space-between; align-items: baseline;
      margin-bottom: 8px;
    }
    .rangeWrap .labelLine b{ font-size: 13px; }
    .rangeWrap .labelLine span{ font-size: 12px; color: var(--muted); }
    input[type="range"]{ width: 100%; }

    .checks{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .check{
      display:flex; gap:10px; align-items:center;
      padding: 10px 10px;
      border: 1px solid var(--stroke);
      border-radius: 14px;
      background: rgba(255,255,255,0.6);
      box-shadow: var(--shadow-soft);
      cursor:pointer;
      user-select:none;
    }
    .check input{ transform: scale(1.05); }
    .check span{ font-weight: 650; font-size: 13px; }

    .btnRow{ display:flex; gap:10px; }
    .btn{
      flex: 1;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.62);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 800;
      cursor:pointer;
      box-shadow: var(--shadow-soft);
      transition: background .15s ease, border-color .15s ease, transform .05s ease;
    }
    .btn:hover{ background: rgba(255,255,255,0.78); border-color: var(--stroke-strong); }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{ font-weight: 700; color: var(--muted); }

    /* Map glass card */
    #mapCard{
      grid-column: 2; grid-row: 1;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      overflow: hidden;
      position: relative;
      min-height: 0;
    }
    #map{ height: 100%; }

    /* Schools list */
    #listCard{
      grid-column: 2; grid-row: 2;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      overflow: hidden;
      display:flex;
      flex-direction: column;
      min-height: 0;
    }
    #listHeader{
      padding: 12px 14px;
      border-bottom: 1px solid var(--stroke);
      background: linear-gradient(to bottom, rgba(255,255,255,0.76), rgba(255,255,255,0.60));
      display:flex; align-items:center; justify-content: space-between; gap: 10px;
    }
    #listHeader .left{ display:flex; flex-direction: column; }
    #listHeader .left b{ font-size: 13px; }
    #listHeader .left span{ font-size: 12px; color: var(--muted); margin-top: 2px; }
    #search{
      width: 260px;
      max-width: 38vw;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.62);
      border-radius: 14px;
      padding: 10px 10px;
      font-size: 13px;
      outline: none;
      box-shadow: var(--shadow-soft);
    }
    #schoolsList{
      padding: 10px 14px 14px 14px;
      overflow: auto;
      min-height: 0;
    }
    .row{
      display:grid;
      grid-template-columns: 1.2fr 1fr 100px 150px;
      gap: 10px;
      padding: 10px 10px;
      border: 1px solid var(--stroke);
      border-radius: 14px;
      background: rgba(255,255,255,0.6);
      box-shadow: var(--shadow-soft);
      margin-bottom: 10px;
      cursor: pointer;
      transition: background .15s ease, border-color .15s ease;
    }
    .row:hover{ background: rgba(255,255,255,0.78); border-color: var(--stroke-strong); }
    .row .name{ font-weight: 800; font-size: 13px; }
    .row .meta{ font-size: 12px; color: var(--muted); margin-top: 2px; }
    .row .girls{ font-weight: 900; text-align:right; font-variant-numeric: tabular-nums; }
    .row .addr{ font-size: 12px; color: var(--muted); line-height: 1.25; }

    @media (max-width: 1080px){
      #app{ grid-template-columns: 1fr; grid-template-rows: auto 1fr 260px; }
      #sidebar{ grid-column: 1; grid-row: 1; }
      #mapCard{ grid-column: 1; grid-row: 2; }
      #listCard{ grid-column: 1; grid-row: 3; }
      #search{ width: 100%; max-width: none; }
      .row{ grid-template-columns: 1.4fr 1fr 90px; }
      .row .addr{ display:none; }
    }

    /* Leaflet popup polish */
    .leaflet-popup-content-wrapper{
      border-radius: 14px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.18);
    }

    /* ===== NEW: Compact horizontal legend ===== */
    .legend-compact{
      background: rgba(255,255,255,0.60);
      border: 1px solid rgba(0,0,0,0.10);
      border-radius: 14px;
      padding: 8px 10px;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.10);
      max-width: min(680px, calc(100vw - 420px)); /* чтобы не лезла под сайдбар */
      pointer-events: none; /* важно: карта кликается под легендой */
    }
    .legend-compact .title{
      font-size: 12px;
      font-weight: 800;
      color: rgba(20,20,25,0.72);
      margin: 0 0 6px 0;
      letter-spacing: -0.01em;
    }
    .legend-compact .items{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .legend-compact .item{
      display:flex;
      gap: 8px;
      align-items: center;
      padding: 6px 8px;
      border-radius: 12px;
      background: rgba(255,255,255,0.45);
      border: 1px solid rgba(0,0,0,0.06);
    }
    .legend-compact .swatch{
      width: 22px;
      height: 12px;
      border-radius: 6px;
      border: 1px solid rgba(0,0,0,0.12);
    }
    .legend-compact .lbl{
      font-size: 12px;
      color: rgba(20,20,25,0.78);
      white-space: nowrap;
    }

    /* Error panel */
    #err{
      position:fixed;
      right:16px;
      bottom:16px;
      max-width:520px;
      white-space:pre-wrap;
      background: rgba(15, 15, 15, 0.92);
      color:#fff;
      padding:12px 14px;
      border-radius:12px;
      font-size:12px;
      line-height:1.35;
      z-index:9999;
      display:none;
    }
    #err strong{ display:block; margin-bottom:6px; }
  </style>
</head>

<body>
<div id="app">

  <!-- Sidebar -->
  <aside id="sidebar">
    <div id="sidebarHeader">
      <div class="title">Girls Football Map · demo</div>
      <div class="subtitle">Фильтры управляют регионами и школами. Данных по возрастам и соревнованиям пока может не быть, интерфейс уже готов.</div>
    </div>

    <div id="kpis">
      <div class="kpi"><div class="v" id="kpiRegions">—</div><div class="t">регионов</div></div>
      <div class="kpi"><div class="v" id="kpiSchools">—</div><div class="t">школ</div></div>
      <div class="kpi"><div class="v" id="kpiGirls">—</div><div class="t">девочек</div></div>
      <div class="kpi"><div class="v" id="kpiSchoolsWithGirls">—</div><div class="t">школ с девочками</div></div>
    </div>

    <div id="filters">
      <div class="section">
        <h4>Соревнования</h4>

        <label class="chip" title="Подсветить регионы Суперлиги (клубы всегда видны в попапе региона)">
          <input type="checkbox" id="toggleSuperleague" />
          <img src="./assets/superleague_logo.png" alt="Суперлига" />
          <span>Суперлига</span>
          <small id="slStatus">(…)</small>
        </label>

        <label class="chip" title="Подсветить регионы Первой лиги (клубы всегда видны в попапе региона)">
          <input type="checkbox" id="toggleFirstLeague" />
          <img src="./assets/firstleague_logo_orange.png" alt="Первая лига" />
          <span>Первая лига</span>
          <small id="flStatus">(…)</small>
        </label>

        <label class="chip" title="Показать/скрыть общеобразовательные школы проекта ФвШ">
  <input type="checkbox" id="toggleFVSH" checked />
  <span>Школы ФвШ</span>
  <small id="fvshStatus">(…)</small>
</label>

        <div class="hint">Клубы в попапе региона показываются всегда. Галочки управляют только подсветкой.</div>
      </div>

      <div class="section">
        <h4>Регионы</h4>

        <select id="regionSelect" class="select" multiple size="10" title="Можно выбрать несколько регионов"></select>

        <div class="hint">Выбранные регионы остаются “цветными” (по девочкам), остальные приглушаются.</div>

        <div class="btnRow" style="margin-top:10px;">
          <button class="btn secondary" id="clearRegions">Очистить</button>
          <button class="btn" id="selectAllRegions">Выбрать все</button>
        </div>
      </div>

      <div class="section">
        <h4>Пороговые фильтры</h4>

        <div class="rangeWrap" style="margin-bottom:10px;">
          <div class="labelLine"><b>Девочек в школе</b><span>≥ <span id="minGirlsSchoolVal">0</span></span></div>
          <input type="range" id="minGirlsSchool" min="0" max="200" step="1" value="0"/>
        </div>

        <div class="rangeWrap" style="margin-bottom:10px;">
          <div class="labelLine"><b>Девочек в регионе</b><span>≥ <span id="minGirlsRegionVal">0</span></span></div>
          <input type="range" id="minGirlsRegion" min="0" max="2000" step="10" value="0"/>
        </div>

        <div class="rangeWrap">
          <div class="labelLine"><b>Школ с девочками в регионе</b><span>≥ <span id="minSchoolsWithGirlsVal">0</span></span></div>
          <input type="range" id="minSchoolsWithGirls" min="0" max="200" step="1" value="0"/>
        </div>

        <div class="hint">Пока данные неполные: фильтры работают там, где значения есть.</div>
      </div>

      <div class="filterBlock">
  <div class="filterTitle">Девочки в школе</div>

  <label class="chipRow">
    <input type="checkbox" id="onlyGirlsYes" />
    <span>Только “есть девочки”</span>
  </label>

  <label class="chipRow">
    <input type="checkbox" id="onlyGirlsNo" />
    <span>Только “нет девочек”</span>
  </label>

  <div class="hint">Если оба выключены или оба включены, показываем все школы.</div>
</div>

      <div class="section">
        <h4>Возрастные группы</h4>
        <div class="checks">
          <label class="check"><input type="checkbox" class="ageChk" value="5-6"><span>5–6</span></label>
          <label class="check"><input type="checkbox" class="ageChk" value="7-8"><span>7–8</span></label>
          <label class="check"><input type="checkbox" class="ageChk" value="9-10"><span>9–10</span></label>
          <label class="check"><input type="checkbox" class="ageChk" value="11-12"><span>11–12</span></label>
          <label class="check"><input type="checkbox" class="ageChk" value="13-15"><span>13–15</span></label>
          <label class="check"><input type="checkbox" class="ageChk" value="16+"><span>16+</span></label>
        </div>
        <div class="hint">Пока ищем поля по возрастам автоматически. Если полей нет, фильтр мягко игнорируется.</div>
      </div>

      <div class="section">
        <h4>Соревновательная практика</h4>
        <div class="checks">
          <label class="check"><input type="checkbox" class="compChk" value="school"><span>школьные</span></label>
          <label class="check"><input type="checkbox" class="compChk" value="muni"><span>муниципальные</span></label>
          <label class="check"><input type="checkbox" class="compChk" value="region"><span>региональные</span></label>
          <label class="check"><input type="checkbox" class="compChk" value="inter"><span>межрегиональные</span></label>
        </div>
        <div class="hint">Пока данные о соревнованиях добавим позже. Сейчас фильтр готов, будет работать автоматически.</div>
      </div>

      <div class="section">
        <h4>Сервис</h4>
        <div class="btnRow">
          <button class="btn secondary" id="resetAll">Сбросить всё</button>
          <button class="btn" id="fitRussia">Показать РФ</button>
        </div>
      </div>
    </div>
  </aside>

  <!-- Map -->
  <main id="mapCard">
    <div id="map"></div>
  </main>

  <!-- List -->
  <section id="listCard">
    <div id="listHeader">
      <div class="left">
        <b id="listTitle">Список школ</b>
        <span id="listSub">—</span>
      </div>
      <div class="right">
        <input id="search" placeholder="Поиск по названию / городу / регионy" />
      </div>
    </div>
    <div id="schoolsList"></div>
  </section>

</div>

<div id="err"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
(function () {
  const errBox = document.getElementById('err');
  function showErr(title, msg) {
    console.error(title, msg);
    errBox.style.display = 'block';
    errBox.innerHTML = `<strong>${title}</strong>${String(msg || '')}`;
  }
  window.addEventListener('error', (e) => showErr('JS ошибка', e.message || e.error || e));
  window.addEventListener('unhandledrejection', (e) => showErr('Promise ошибка', e.reason || e));

  if (typeof L === 'undefined') {
    showErr('Leaflet не загрузился', 'Проверь доступ к https://unpkg.com (возможно блокировка).');
    return;
  }

  const fmt = new Intl.NumberFormat('ru-RU');

  function normRegion(s) {
    if (!s) return "";
    return String(s)
      .toLowerCase()
      .replaceAll("ё", "е")
      .replace(/[().,"]/g, " ")
      .replace(/\s+/g, " ")
      .trim()
      .replace(/\b(республика|область|край|автономная область|автономный округ|округ|г\.|город)\b/g, "")
      .replace(/\s+/g, " ")
      .trim();
  }

  function hasGirlsInProps(p) {
  if (!p) return false;
  if (p.has_girls === true) return true;
  if (String(p.has_girls).toLowerCase() === "true") return true;

  const girls = Number(p.girls_total ?? p.girls ?? 0);
  return girls > 0;
}

  function styleSportsSchoolMarker(feature) {
  const p = feature.properties || {};
  const hasGirls = (p.has_girls === true) || (String(p.has_girls).toLowerCase() === "true") || (Number(p.girls_total ?? 0) > 0);

  // синий = есть девочки, красный = нет
  const stroke = hasGirls ? "#2563eb" : "#ef4444";
  const fill = hasGirls ? "#3b82f6" : "#f87171";

  return {
    radius: 6,
    weight: 1.5,
    color: stroke,
    fillColor: fill,
    fillOpacity: 0.85
  };
}

  function colorFor(value, breaks) {
    if (value == null) return '#f3f4f6';
    if (value <= breaks[0]) return '#eff6ff';
    if (value <= breaks[1]) return '#dbeafe';
    if (value <= breaks[2]) return '#bfdbfe';
    if (value <= breaks[3]) return '#93c5fd';
    if (value <= breaks[4]) return '#60a5fa';
    return '#3b82f6';
  }

  function styleFill(feature, enabled=true) {
    const girls = feature.properties?.total_girls ?? 0;
    const fill = colorFor(girls, [0, 50, 150, 300, 700]);
    return {
      weight: 1,
      color: enabled ? 'rgba(0,0,0,0.25)' : 'rgba(0,0,0,0.10)',
      fillColor: enabled ? fill : '#f3f4f6',
      fillOpacity: enabled ? 0.55 : 0.20
    };
  }

  function regionBaseHTML(p) {
    const schools = p.total_schools ?? 0;
    const schoolsWithGirls = p.schools_with_girls ?? 0;
    const girls = p.total_girls ?? 0;
    const avg = p.avg_girls_per_school ?? 0;
    return `
      <div class="popup">
        <h3>${p.name ?? 'Регион'}</h3>
        <div class="muted">Сводка по спортшколам 2024</div>
        <div><b>Школ:</b> ${fmt.format(schools)}</div>
        <div><b>Школ с девочками:</b> ${fmt.format(schoolsWithGirls)}</div>
        <div><b>Девочек:</b> ${fmt.format(girls)}</div>
        <div><b>Среднее на школу:</b> ${fmt.format(Math.round(avg*10)/10)}</div>
      </div>
    `;
  }

  async function fetchJSON(url) {
    const res = await fetch(url + '?v=' + Date.now());
    const text = await res.text();
    if (!res.ok) throw new Error(`HTTP ${res.status} при загрузке ${url}\n${text.slice(0,200)}`);
    try { return JSON.parse(text); }
    catch (e) { throw new Error(`Не могу распарсить JSON: ${url}\n${e}\n${text.slice(0,200)}`); }
  }

  // UI refs
  const superCheckbox = document.getElementById('toggleSuperleague');
  const firstCheckbox = document.getElementById('toggleFirstLeague');
  const slStatus = document.getElementById('slStatus');
  const flStatus = document.getElementById('flStatus');

  const fvshCheckbox = document.getElementById('toggleFVSH');
const fvshStatus = document.getElementById('fvshStatus');

let fvshData = null;
let fvshLayer = null;             // GeoJSON слой
let fvshCluster = null;           // отдельный кластер под ФвШ (чтобы можно было скрывать)

  const regionSelect = document.getElementById('regionSelect');
  const clearRegionsBtn = document.getElementById('clearRegions');
  const selectAllRegionsBtn = document.getElementById('selectAllRegions');

  const minGirlsSchool = document.getElementById('minGirlsSchool');
  const minGirlsSchoolVal = document.getElementById('minGirlsSchoolVal');

  const minGirlsRegion = document.getElementById('minGirlsRegion');
  const minGirlsRegionVal = document.getElementById('minGirlsRegionVal');

  const minSchoolsWithGirls = document.getElementById('minSchoolsWithGirls');
  const minSchoolsWithGirlsVal = document.getElementById('minSchoolsWithGirlsVal');

  const ageChks = Array.from(document.querySelectorAll('.ageChk'));
  const compChks = Array.from(document.querySelectorAll('.compChk'));

  document.getElementById('onlyGirlsYes')?.addEventListener('change', rerunAll);
document.getElementById('onlyGirlsNo')?.addEventListener('change', rerunAll);

  const resetAllBtn = document.getElementById('resetAll');
  const fitRussiaBtn = document.getElementById('fitRussia');

  const listTitle = document.getElementById('listTitle');
  const listSub = document.getElementById('listSub');
  const searchInput = document.getElementById('search');
  const schoolsList = document.getElementById('schoolsList');

  // Map init
  const map = L.map('map', { preferCanvas: true }).setView([61.5, 96.5], 3);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  const cluster = L.markerClusterGroup({ chunkedLoading: true, spiderfyOnMaxZoom: true, showCoverageOnHover: false });

  // Data holders
  let regionsData = null;
  let pointsData = null;

  let regionsFillLayer = null;
  let superOutlineLayer = null;
  let firstOutlineLayer = null;

  let superBrand = { color: "#d000e0", colorDark: "#501070", logo: "./assets/superleague_logo.png" };
  let firstBrand = { color: "#ff4b00", colorDark: "#111111", logo: "./assets/firstleague_logo_orange.png" };

  let superByRegion = {};
  let firstByRegion = {};

  let pointsGeoLayer = null;
  let currentFilteredPointFeatures = [];

  // ===== NEW: compact legend control =====
  function addCompactLegend(){
    const legend = L.control({ position: 'bottomleft' });
    legend.onAdd = function() {
      const div = L.DomUtil.create('div', 'legend-compact');
      div.innerHTML = `
        <div class="title">Заливка: девочек в регионе</div>
        <div class="items">
          <div class="item"><span class="swatch" style="background:#eff6ff"></span><span class="lbl">0</span></div>
          <div class="item"><span class="swatch" style="background:#dbeafe"></span><span class="lbl">1–50</span></div>
          <div class="item"><span class="swatch" style="background:#bfdbfe"></span><span class="lbl">51–150</span></div>
          <div class="item"><span class="swatch" style="background:#93c5fd"></span><span class="lbl">151–300</span></div>
          <div class="item"><span class="swatch" style="background:#60a5fa"></span><span class="lbl">301–700</span></div>
          <div class="item"><span class="swatch" style="background:#3b82f6"></span><span class="lbl">701+</span></div>
        </div>
      `;
      return div;
    };
    legend.addTo(map);
  }
  addCompactLegend();

  function renderClubLines(items) {
    return (items || []).map(x => {
      if (typeof x === "string") return `• ${x}`;
      const club = x.club || "Клуб";
      const city = x.city ? ` (${x.city})` : "";
      return `• ${club}${city}`;
    }).join("<br>");
  }

  function haversineKm(lat1, lon1, lat2, lon2){
  const R = 6371;
  const toRad = (x) => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a =
    Math.sin(dLat/2)*Math.sin(dLat/2) +
    Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) *
    Math.sin(dLon/2)*Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

  function buildSportsIndex(points){
  const arr = [];
  for (const f of (points.features || [])){
    const coords = f.geometry?.coordinates;
    if (!coords || coords.length < 2) continue;
    const p = f.properties || {};
    arr.push({
      lat: coords[1],
      lon: coords[0],
      name: p.name || "Спортшкола",
      region: p.region || "",
      city: p.city || "",
      address: p.address || ""
    });
  }
  return arr;
}

  function findNearestSportsSchool(lat, lon, sportsArr){
  let best = null;
  let bestD = Infinity;
  for (const s of sportsArr){
    const d = haversineKm(lat, lon, s.lat, s.lon);
    if (d < bestD){
      bestD = d;
      best = s;
    }
  }
  if (!best) return null;
  return { ...best, distanceKm: bestD };
}

  function buildRegionPopup(p) {
    const base = regionBaseHTML(p);
    const key = normRegion(p.name);

    const sl = superByRegion[key] || [];
    const fl = firstByRegion[key] || [];

    let extra = "";

    if (sl.length > 0) {
      extra += `
        <div style="margin-top:10px; padding-top:10px; border-top:1px solid rgba(0,0,0,0.08);">
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
            <img src="${superBrand.logo}" alt="Суперлига" style="width:18px; height:18px; object-fit:contain;">
            <b style="color:${superBrand.color}">Суперлига</b>
          </div>
          <div style="margin-top:4px; line-height:1.35;">
            ${renderClubLines(sl)}
          </div>
        </div>
      `;
    }

    if (fl.length > 0) {
      extra += `
        <div style="margin-top:10px; padding-top:10px; border-top:1px solid rgba(0,0,0,0.08);">
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
            <img src="${firstBrand.logo}" alt="Первая лига" style="width:18px; height:18px; object-fit:contain;">
            <b style="color:${firstBrand.color}">Первая лига</b>
          </div>
          <div style="margin-top:4px; line-height:1.35;">
            ${renderClubLines(fl)}
          </div>
        </div>
      `;
    }

    return extra ? base.replace("</div>", extra + "</div>") : base;
  }

  function updateAllRegionPopups() {
    if (!regionsFillLayer) return;
    regionsFillLayer.eachLayer(layer => {
      const p = layer.feature?.properties || {};
      layer.bindPopup(buildRegionPopup(p), { maxWidth: 380 });
    });
  }

  function computeMatchedStatus(byRegionObj, statusEl) {
    if (!statusEl || !regionsFillLayer) return;
    const geoRegions = new Set();
    regionsFillLayer.eachLayer(l => {
      const p = l.feature?.properties || {};
      geoRegions.add(normRegion(p.name));
    });
    const keys = Object.keys(byRegionObj);
    const matched = keys.filter(k => geoRegions.has(k)).length;
    statusEl.textContent = `(регионов: ${keys.length}, совпало: ${matched})`;
  }

  function getSelectedRegionNormSetFromUI(){
    const selected = Array.from(regionSelect.selectedOptions || []).map(o => o.value);
    if (selected.length === 0) return null;
    return new Set(selected.map(normRegion));
  }

  function getEnabledRegionSet(){
    const selectedSet = getSelectedRegionNormSetFromUI();
    const minGirlsR = Number(minGirlsRegion.value || 0);
    const minSWG = Number(minSchoolsWithGirls.value || 0);

    const enabled = new Set();
    (regionsData?.features || []).forEach(f => {
      const p = f.properties || {};
      const key = normRegion(p.name);
      const inSelected = !selectedSet || selectedSet.has(key);

      const girls = Number(p.total_girls ?? 0);
      const swg = Number(p.schools_with_girls ?? 0);

      const pass = inSelected && (girls >= minGirlsR) && (swg >= minSWG);
      if (pass) enabled.add(key);
    });
    return enabled;
  }

  function rebuildOutlines() {
    if (!regionsData) return;

    if (superOutlineLayer) map.removeLayer(superOutlineLayer);
    if (firstOutlineLayer) map.removeLayer(firstOutlineLayer);
    superOutlineLayer = null;
    firstOutlineLayer = null;

    const enabled = getEnabledRegionSet();

    if (superCheckbox?.checked) {
      superOutlineLayer = L.geoJSON(regionsData, {
        interactive: false,
        style: (feature) => {
          const key = normRegion(feature?.properties?.name);
          if (!enabled.has(key)) return { opacity: 0, fillOpacity: 0 };
          const has = (superByRegion[key] || []).length > 0;
          if (!has) return { opacity: 0, fillOpacity: 0 };
          return { color: superBrand.color, weight: 3, opacity: 1, fillOpacity: 0 };
        }
      }).addTo(map);
      superOutlineLayer.bringToFront();
    }

    if (firstCheckbox?.checked) {
      firstOutlineLayer = L.geoJSON(regionsData, {
        interactive: false,
        style: (feature) => {
          const key = normRegion(feature?.properties?.name);
          if (!enabled.has(key)) return { opacity: 0, fillOpacity: 0 };
          const has = (firstByRegion[key] || []).length > 0;
          if (!has) return { opacity: 0, fillOpacity: 0 };
          return { color: firstBrand.color, weight: 3, opacity: 1, dashArray: "7 5", lineCap: "round", lineJoin: "round", fillOpacity: 0 };
        }
      }).addTo(map);
      firstOutlineLayer.bringToFront();
    }

    if (regionsFillLayer) regionsFillLayer.bringToBack();
  }

  function applyRegionFilterStyles(){
    if (!regionsFillLayer) return;
    const enabled = getEnabledRegionSet();
    regionsFillLayer.eachLayer(layer => {
      const p = layer.feature?.properties || {};
      const key = normRegion(p.name);
      const on = enabled.has(key);
      layer.setStyle(styleFill(layer.feature, on));
    });
    rebuildOutlines();
  }

  // future-proof stubs (as in previous version)
  function schoolHasAnySelectedAges(p, selectedAges){
    if (selectedAges.length === 0) return true;
    const keys = Object.keys(p || {});
    for (const age of selectedAges){
      const needle = age.replace('+','\\+');
      const re = new RegExp(needle, 'i');
      const matching = keys.filter(k => re.test(k));
      if (matching.length === 0) return false;
      const ok = matching.some(k => {
        const v = p[k];
        if (v === true) return true;
        const num = Number(v);
        return Number.isFinite(num) && num > 0;
      });
      if (!ok) return false;
    }
    return true;
  }
  function schoolMatchesCompetitions(p, selectedComps){
    if (selectedComps.length === 0) return true;
    const mapNeedles = {
      school: /школьн/i,
      muni: /муницип/i,
      region: /регионал/i,
      inter: /межрегион/i
    };
    const keys = Object.keys(p || {});
    const anyCompKey = keys.some(k => /(школьн|муницип|регионал|межрегион)/i.test(k));
    if (!anyCompKey) return false;

    for (const c of selectedComps){
      const re = mapNeedles[c];
      const matching = keys.filter(k => re.test(k));
      if (matching.length === 0) return false;
      const ok = matching.some(k => {
        const v = p[k];
        if (v === true) return true;
        const num = Number(v);
        return Number.isFinite(num) && num > 0;
      });
      if (!ok) return false;
    }
    return true;
  }

  function escapeHTML(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function readUIState(){
    const minGS = Number(minGirlsSchool.value || 0);
    const selectedAges = ageChks.filter(x => x.checked).map(x => x.value);
    const selectedComps = compChks.filter(x => x.checked).map(x => x.value);
    const search = (searchInput.value || "").trim().toLowerCase();
    return { minGS, selectedAges, selectedComps, search };
  }

 function applySchoolsFilter(){
  if (!pointsData || !pointsGeoLayer) return;

  const enabledRegions = getEnabledRegionSet();
  const state = readUIState();

  // ✅ читаем UI один раз
  const onlyYes = document.getElementById('onlyGirlsYes')?.checked;
  const onlyNo  = document.getElementById('onlyGirlsNo')?.checked;

  const filtered = [];

  for (const f of (pointsData.features || [])){
    const p = f.properties || {};

    const regionKey = normRegion(p.region || p.Region || p.name_region || p.subject || "");
    const regionOK = enabledRegions.size === 0 ? true : enabledRegions.has(regionKey);

    const girls = Number(p.girls_total ?? p.girls ?? p["Численность занимающихся футболом девочек"] ?? 0);
    const girlsOK = girls >= state.minGS;

    const agesOK = schoolHasAnySelectedAges(p, state.selectedAges);
    const compsOK = schoolMatchesCompetitions(p, state.selectedComps);

    // ✅ определяем "есть девочки" (приоритет: явный флаг -> число)
    const hasGirls =
      (p.has_girls === true) ||
      (String(p.has_girls).toLowerCase() === "true") ||
      (girls > 0);

    // ✅ фильтр "только есть/только нет"
    // логика:
    // - оба выключены -> показываем все
    // - оба включены -> показываем все
    // - включен только один -> фильтруем
    let girlsPresenceOK = true;
    if (onlyYes !== onlyNo) { // значит включен ровно один
      if (onlyYes && !hasGirls) girlsPresenceOK = false;
      if (onlyNo  &&  hasGirls) girlsPresenceOK = false;
    }

    if (regionOK && girlsOK && agesOK && compsOK && girlsPresenceOK) {
      filtered.push(f);
    }
  }

  currentFilteredPointFeatures = filtered;

  cluster.clearLayers();
  pointsGeoLayer = L.geoJSON({ type:"FeatureCollection", features: filtered }, {
    pointToLayer: (feature, latlng) => L.circleMarker(latlng, styleSportsSchoolMarker(feature)),
    onEachFeature: (feature, layer) => {
      const p = feature.properties || {};
      const girls = Number(p.girls_total ?? p.girls ?? 0);

      const html = `
        <div class="popup">
          <h3>${p.name ?? "Без названия"}</h3>
          <div class="muted">${p.region ?? ""}${p.city ? ", " + p.city : ""}</div>
          <div>${p.address ?? ""}</div>
          <div style="margin-top:8px;"><b>Девочек:</b> ${fmt.format(girls)}</div>
          ${p.phone ? `<div><b>Тел:</b> ${p.phone}</div>` : ""}
          ${p.email ? `<div><b>Email:</b> ${p.email}</div>` : ""}
        </div>
      `;
      layer.bindPopup(html, { maxWidth: 360 });
    }
  });



    cluster.addLayer(pointsGeoLayer);
    map.addLayer(cluster);

    renderSchoolsList();
  }

  function renderSchoolsList(){
    const state = readUIState();
    let rows = currentFilteredPointFeatures.slice();
    if (state.search){
      rows = rows.filter(f => {
        const p = f.properties || {};
        const hay = [p.name, p.region, p.city, p.address].filter(Boolean).join(" ").toLowerCase();
        return hay.includes(state.search);
      });
    }
    rows.sort((a,b) => (Number(b.properties?.girls_total ?? 0) - Number(a.properties?.girls_total ?? 0)));

    listTitle.textContent = "Список школ (отфильтровано)";
    listSub.textContent = `${fmt.format(rows.length)} школ`;

    schoolsList.innerHTML = "";
    if (rows.length === 0){
      schoolsList.innerHTML = `<div style="padding:12px; color:rgba(20,20,25,0.55);">Ничего не найдено по текущим фильтрам.</div>`;
      return;
    }

    for (const f of rows.slice(0, 400)) {
      const p = f.properties || {};
      const girls = Number(p.girls_total ?? 0);
      const name = p.name ?? "Без названия";
      const region = p.region ?? "";
      const city = p.city ?? "";
      const addr = p.address ?? "";

      const el = document.createElement('div');
      el.className = 'row';
      el.innerHTML = `
        <div>
          <div class="name">${escapeHTML(name)}</div>
          <div class="meta">${escapeHTML([region, city].filter(Boolean).join(", "))}</div>
        </div>
        <div class="addr">${escapeHTML(addr)}</div>
        <div class="girls">${fmt.format(girls)}</div>
        <div style="text-align:right; font-size:12px; color:rgba(20,20,25,0.55); align-self:center;">девочек</div>
      `;

      el.addEventListener('click', () => {
        const coords = f.geometry?.coordinates;
        if (coords && coords.length >= 2){
          const latlng = [coords[1], coords[0]];
          map.setView(latlng, Math.max(map.getZoom(), 10), { animate: true });
        }
      });

      schoolsList.appendChild(el);
    }
  }

  function fillRegionSelectFromGeoJSON(){
    const regions = (regionsData?.features || [])
      .map(f => f.properties?.name)
      .filter(Boolean)
      .sort((a,b) => String(a).localeCompare(String(b), 'ru'));

    regionSelect.innerHTML = "";
    for (const r of regions){
      const opt = document.createElement('option');
      opt.value = r;
      opt.textContent = r;
      regionSelect.appendChild(opt);
    }
  }

  function setRangesFromData(){
    const maxGirlsSchool = Math.max(0, ...(pointsData?.features || []).map(f => Number(f.properties?.girls_total ?? 0) || 0));
    minGirlsSchool.max = String(Math.max(50, Math.ceil(maxGirlsSchool/10)*10));
    minGirlsSchool.value = "0";
    minGirlsSchoolVal.textContent = "0";

    const maxGirlsRegion = Math.max(0, ...(regionsData?.features || []).map(f => Number(f.properties?.total_girls ?? 0) || 0));
    minGirlsRegion.max = String(Math.max(100, Math.ceil(maxGirlsRegion/50)*50));
    minGirlsRegion.step = String(maxGirlsRegion > 500 ? 25 : 10);
    minGirlsRegion.value = "0";
    minGirlsRegionVal.textContent = "0";

    const maxSWG = Math.max(0, ...(regionsData?.features || []).map(f => Number(f.properties?.schools_with_girls ?? 0) || 0));
    minSchoolsWithGirls.max = String(Math.max(20, maxSWG));
    minSchoolsWithGirls.value = "0";
    minSchoolsWithGirlsVal.textContent = "0";
  }

  function fitToRussia(){
    if (regionsFillLayer) map.fitBounds(regionsFillLayer.getBounds().pad(0.1));
  }

  function wireEvents(){
    function refreshLabels(){
      minGirlsSchoolVal.textContent = String(minGirlsSchool.value);
      minGirlsRegionVal.textContent = String(minGirlsRegion.value);
      minSchoolsWithGirlsVal.textContent = String(minSchoolsWithGirls.value);
    }
    const rerunAll = () => {
      refreshLabels();
      applyRegionFilterStyles();
      applySchoolsFilter();
      updateAllRegionPopups();
    };

    regionSelect.addEventListener('change', rerunAll);

    minGirlsSchool.addEventListener('input', rerunAll);
    minGirlsRegion.addEventListener('input', rerunAll);
    minSchoolsWithGirls.addEventListener('input', rerunAll);

    ageChks.forEach(x => x.addEventListener('change', rerunAll));
    compChks.forEach(x => x.addEventListener('change', rerunAll));

    superCheckbox.addEventListener('change', rebuildOutlines);
    firstCheckbox.addEventListener('change', rebuildOutlines);

    clearRegionsBtn.addEventListener('click', () => {
      Array.from(regionSelect.options).forEach(o => o.selected = false);
      rerunAll();
    });
    selectAllRegionsBtn.addEventListener('click', () => {
      Array.from(regionSelect.options).forEach(o => o.selected = true);
      rerunAll();
    });

    searchInput.addEventListener('input', renderSchoolsList);

    resetAllBtn.addEventListener('click', () => {
      superCheckbox.checked = false;
      firstCheckbox.checked = false;

      document.getElementById('onlyGirlsYes').checked = false;
document.getElementById('onlyGirlsNo').checked = false;

      Array.from(regionSelect.options).forEach(o => o.selected = false);

      minGirlsSchool.value = "0";
      minGirlsRegion.value = "0";
      minSchoolsWithGirls.value = "0";

      ageChks.forEach(x => x.checked = false);
      compChks.forEach(x => x.checked = false);

      searchInput.value = "";

      rerunAll();
      fitToRussia();
    });

    fitRussiaBtn.addEventListener('click', fitToRussia);

    refreshLabels();
  }

  // Load base
  Promise.all([
    fetchJSON('./russia_subjects_with_sportschools2024.json'),
    fetchJSON('https://ekaterinamochalova.github.io/girls-football-map-demo/schools_points_master.json')
  ])
  .then(([regions, points]) => {
    regionsData = regions;
    pointsData = points;

    // KPIs
    const totalRegions = regions.features?.length ?? 0;
    const sumGirls = (regions.features || []).reduce((a,f)=>a + (f.properties?.total_girls ?? 0), 0);
    const sumSchools = (regions.features || []).reduce((a,f)=>a + (f.properties?.total_schools ?? 0), 0);
    const sumSchoolsWithGirls = (regions.features || []).reduce((a,f)=>a + (f.properties?.schools_with_girls ?? 0), 0);

    document.getElementById('kpiRegions').textContent = fmt.format(totalRegions);
    document.getElementById('kpiGirls').textContent = fmt.format(sumGirls);
    document.getElementById('kpiSchools').textContent = fmt.format(points.features?.length ?? sumSchools);
    document.getElementById('kpiSchoolsWithGirls').textContent = fmt.format(sumSchoolsWithGirls);

    // Regions
    regionsFillLayer = L.geoJSON(regions, {
      style: (feature) => styleFill(feature, true),
      onEachFeature: (feature, layer) => {
        const p = feature.properties || {};
        layer.bindPopup(regionBaseHTML(p), { maxWidth: 380 });
      }
    }).addTo(map);

    // Points
    pointsGeoLayer = L.geoJSON(points, {
      pointToLayer: (feature, latlng) => L.circleMarker(latlng, styleSportsSchoolMarker(feature)),
      onEachFeature: (feature, layer) => {
        const p = feature.properties || {};
        const girls = Number(p.girls_total ?? 0);
        const html = `
          <div class="popup">
            <h3>${p.name ?? "Без названия"}</h3>
            <div class="muted">${p.region ?? ""}${p.city ? ", " + p.city : ""}</div>
            <div>${p.address ?? ""}</div>
            <div style="margin-top:8px;"><b>Девочек:</b> ${fmt.format(girls)}</div>
            ${p.phone ? `<div><b>Тел:</b> ${p.phone}</div>` : ""}
            ${p.email ? `<div><b>Email:</b> ${p.email}</div>` : ""}
          </div>
        `;
        layer.bindPopup(html, { maxWidth: 360 });
      }
    });

    const sportsArr = buildSportsIndex(points);

// === FVSH layer load ===
fetchJSON('./data/fvsh_schools.json')
  .then(data => {
    fvshData = data;
    if (fvshStatus) fvshStatus.textContent = `(${fmt.format(data.features?.length || 0)})`;

    fvshCluster = L.markerClusterGroup({
      chunkedLoading: true,
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false
    });

    fvshLayer = L.geoJSON(fvshData, {
      pointToLayer: (feature, latlng) => L.circleMarker(latlng, {
        radius: 6,
        weight: 2,
        // другой цвет для ФвШ
        color: '#ff4b00',
        fillColor: '#ff4b00',
        fillOpacity: 0.70
      }),
      onEachFeature: (feature, layer) => {
        layer.on('click', () => {
          const coords = feature.geometry?.coordinates;
          if (!coords || coords.length < 2) return;
          const lat = coords[1], lon = coords[0];
          const p = feature.properties || {};

          const nearest = findNearestSportsSchool(lat, lon, sportsArr);

          const nearestHtml = nearest ? `
            <div style="margin-top:10px; padding-top:10px; border-top:1px solid rgba(0,0,0,0.10);">
              <div style="font-weight:800;">Ближайшая спортшкола</div>
              <div style="margin-top:6px;"><b>${nearest.name}</b></div>
              <div style="color:#666; font-size:12px; margin-top:2px;">
                ${[nearest.region, nearest.city].filter(Boolean).join(", ")}
              </div>
              <div style="margin-top:6px;">
                <b>Расстояние:</b> ${fmt.format(Math.round(nearest.distanceKm * 10) / 10)} км
              </div>
            </div>
          ` : `<div style="margin-top:10px; color:#666;">Не удалось найти ближайшую спортшколу.</div>`;

          const html = `
            <div class="popup">
              <h3>${p.name || "Школа ФвШ"}</h3>
              <div class="muted">${[p.region, p.city].filter(Boolean).join(", ")}</div>
              ${p.address ? `<div>${p.address}</div>` : ""}
              ${nearestHtml}
            </div>
          `;

          layer.bindPopup(html, { maxWidth: 380 }).openPopup();
        });
      }
    });

    fvshCluster.addLayer(fvshLayer);

    // по умолчанию показываем, если чекбокс включен
    if (!fvshCheckbox || fvshCheckbox.checked){
      map.addLayer(fvshCluster);
    }

    if (fvshCheckbox){
      fvshCheckbox.addEventListener('change', () => {
        if (fvshCheckbox.checked) map.addLayer(fvshCluster);
        else map.removeLayer(fvshCluster);
      });
    }
  })
  .catch(e => {
    console.error("FVSH overlay failed:", e);
    if (fvshStatus) fvshStatus.textContent = '(ошибка)';
  });

    cluster.addLayer(pointsGeoLayer);
    map.addLayer(cluster);

    map.fitBounds(regionsFillLayer.getBounds().pad(0.1));

    fillRegionSelectFromGeoJSON();
    setRangesFromData();

    currentFilteredPointFeatures = (pointsData.features || []);
    wireEvents();
    renderSchoolsList();

    return Promise.all([
      fetchJSON('./data/superleague_clubs.json').catch(e => { console.error("Superleague data failed:", e); if (slStatus) slStatus.textContent = "(ошибка)"; return null; }),
      fetchJSON('./data/firstleague_clubs_v1.json').catch(e => { console.error("First league data failed:", e); if (flStatus) flStatus.textContent = "(ошибка)"; return null; })
    ]);
  })
  .then(([sl, fl]) => {
    if (sl) {
      superBrand = sl.brand || superBrand;
      superByRegion = {};
      for (const [rName, clubs] of Object.entries(sl.by_region || {})) {
        superByRegion[normRegion(rName)] = (clubs || []).filter(Boolean);
      }
      computeMatchedStatus(superByRegion, slStatus);
    } else {
      if (slStatus) slStatus.textContent = "(нет данных)";
    }

    if (fl) {
      firstBrand = fl.brand || firstBrand;
      firstByRegion = {};
      for (const [rName, clubs] of Object.entries(fl.by_region || {})) {
        firstByRegion[normRegion(rName)] = (clubs || []).filter(Boolean);
      }
      computeMatchedStatus(firstByRegion, flStatus);
    } else {
      if (flStatus) flStatus.textContent = "(нет данных)";
    }

    updateAllRegionPopups();
    applyRegionFilterStyles();
    applySchoolsFilter();
    rebuildOutlines();
    errBox.style.display = 'none';
  })
  .catch(err => showErr('Ошибка загрузки данных', err));

})();
</script>
</body>
</html>



