<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Карта девичьего футбола — демо</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

  <style>
    html, body { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; }
    #app { height: 100%; display: flex; flex-direction: column; }
    #topbar {
      padding: 12px 14px; border-bottom: 1px solid #eee;
      display: flex; gap: 12px; align-items: center; flex-wrap: wrap;
      background: #fff;
    }
    .kpi { background: #f6f7f9; border: 1px solid #eee; border-radius: 12px; padding: 10px 12px; min-width: 140px; }
    .kpi .v { font-weight: 700; font-size: 18px; }
    .kpi .t { color: #666; font-size: 12px; margin-top: 2px; }
    #map { flex: 1; min-height: 420px; }

    .legend {
      position: absolute; bottom: 16px; left: 16px; z-index: 999;
      background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 10px 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      font-size: 12px;
    }
    .legend .row { display:flex; align-items:center; gap:8px; margin:6px 0; }
    .swatch { width: 14px; height: 14px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.15); }

    .popup h3 { margin: 0 0 6px 0; font-size: 15px; }
    .popup .muted { color: #666; font-size: 12px; margin-bottom: 6px; }

    /* Chip (checkbox filter) */
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border: 1px solid #eee;
      border-radius: 12px;
      background: #fff;
      user-select: none;
    }
    .chip input { transform: scale(1.1); }
    .chip img { width: 26px; height: 26px; object-fit: contain; }
    .chip span { font-weight: 600; }

    /* Видимая панель ошибок */
    #err {
      position: fixed;
      right: 16px;
      bottom: 16px;
      max-width: 520px;
      white-space: pre-wrap;
      background: rgba(15, 15, 15, 0.92);
      color: #fff;
      padding: 12px 14px;
      border-radius: 12px;
      font-size: 12px;
      line-height: 1.35;
      z-index: 9999;
      display: none;
    }
    #err strong { display:block; margin-bottom: 6px; }
  </style>
</head>
<body>
<div id="app">
  <div id="topbar">
    <div class="kpi"><div class="v" id="kpiRegions">—</div><div class="t">регионов в GeoJSON</div></div>
    <div class="kpi"><div class="v" id="kpiSchools">—</div><div class="t">школ (точек)</div></div>
    <div class="kpi"><div class="v" id="kpiGirls">—</div><div class="t">девочек (в сумме)</div></div>
    <div class="kpi"><div class="v" id="kpiSchoolsWithGirls">—</div><div class="t">школ с девочками</div></div>

    <!-- Superleague toggle -->
    <label class="chip" title="Подсветить регионы Суперлиги и показать клубы в попапе региона">
      <input type="checkbox" id="toggleSuperleague" />
      <img src="./assets/superleague_logo.png" alt="Суперлига" />
      <span>Суперлига</span>
      <small id="slStatus" style="color:#666;">(загрузка…)</small>
    </label>
  </div>
  <div id="map"></div>
</div>

<div id="err"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
(function () {
  const errBox = document.getElementById('err');
  function showErr(title, msg) {
    console.error(title, msg);
    errBox.style.display = 'block';
    errBox.innerHTML = `<strong>${title}</strong>${String(msg || '')}`;
  }

  // ловим любые “тихие” падения
  window.addEventListener('error', (e) => showErr('JS ошибка', e.message || e.error || e));
  window.addEventListener('unhandledrejection', (e) => showErr('Promise ошибка', e.reason || e));

  // проверим, что Leaflet реально загрузился
  if (typeof L === 'undefined') {
    showErr('Leaflet не загрузился', 'Проверь доступ к https://unpkg.com (возможно блокировка).');
    return;
  }

  // --- map init (ЭТО ДОЛЖНО ВСЕГДА ОТРИСОВАТЬ ТАЙЛЫ И ЗУМ) ---
  const map = L.map('map', { preferCanvas: true }).setView([61.5, 96.5], 3);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  const fmt = new Intl.NumberFormat('ru-RU');

  function normRegion(s) {
  if (!s) return "";
  return String(s)
    .toLowerCase()
    .replaceAll("ё", "е")
    .replace(/[().,"]/g, " ")
    .replace(/\s+/g, " ")
    .trim()
    // убираем “типы” регионов, чтобы сравнение было по ядру
    .replace(/\b(республика|область|край|автономная область|автономный округ|округ|г\.|город)\b/g, "")
    .replace(/\s+/g, " ")
    .trim();
}

  function colorFor(value, breaks) {
    if (value == null) return '#f3f4f6';
    if (value <= breaks[0]) return '#eff6ff';
    if (value <= breaks[1]) return '#dbeafe';
    if (value <= breaks[2]) return '#bfdbfe';
    if (value <= breaks[3]) return '#93c5fd';
    if (value <= breaks[4]) return '#60a5fa';
    return '#3b82f6';
  }

  function styleRegion(feature) {
    const girls = feature.properties?.total_girls ?? 0;
    const fill = colorFor(girls, [0, 50, 150, 300, 700]);
    return { weight: 1, color: 'rgba(0,0,0,0.25)', fillColor: fill, fillOpacity: 0.55 };
  }

  function regionPopupHTML(p) {
    const schools = p.total_schools ?? 0;
    const schoolsWithGirls = p.schools_with_girls ?? 0;
    const girls = p.total_girls ?? 0;
    const avg = p.avg_girls_per_school ?? 0;
    return `
      <div class="popup">
        <h3>${p.name ?? 'Регион'}</h3>
        <div class="muted">Сводка по спортшколам 2024</div>
        <div><b>Школ:</b> ${fmt.format(schools)}</div>
        <div><b>Школ с девочками:</b> ${fmt.format(schoolsWithGirls)}</div>
        <div><b>Девочек:</b> ${fmt.format(girls)}</div>
        <div><b>Среднее на школу:</b> ${fmt.format(Math.round(avg*10)/10)}</div>
      </div>
    `;
  }

  async function fetchJSON(url) {
    const res = await fetch(url + '?v=' + Date.now()); // cache-bust
    const text = await res.text();
    if (!res.ok) throw new Error(`HTTP ${res.status} при загрузке ${url}\n${text.slice(0,200)}`);
    try { return JSON.parse(text); }
    catch (e) { throw new Error(`Не могу распарсить JSON: ${url}\n${e}\n${text.slice(0,200)}`); }
  }

  const cluster = L.markerClusterGroup({ chunkedLoading: true, spiderfyOnMaxZoom: true, showCoverageOnHover: false });

  // --- main load ---
  Promise.all([
    fetchJSON('./russia_subjects_with_sportschools2024.json'),
    fetchJSON('./schools_points.json')
  ])
  .then(([regions, points]) => {
    // KPI
    const totalRegions = regions.features?.length ?? 0;
    const sumGirls = (regions.features || []).reduce((a,f)=>a + (f.properties?.total_girls ?? 0), 0);
    const sumSchools = (regions.features || []).reduce((a,f)=>a + (f.properties?.total_schools ?? 0), 0);
    const sumSchoolsWithGirls = (regions.features || []).reduce((a,f)=>a + (f.properties?.schools_with_girls ?? 0), 0);

    document.getElementById('kpiRegions').textContent = fmt.format(totalRegions);
    document.getElementById('kpiGirls').textContent = fmt.format(sumGirls);
    document.getElementById('kpiSchools').textContent = fmt.format(points.features?.length ?? sumSchools);
    document.getElementById('kpiSchoolsWithGirls').textContent = fmt.format(sumSchoolsWithGirls);

    // Regions
    const regionsLayer = L.geoJSON(regions, {
      style: styleRegion,
      onEachFeature: (feature, layer) => {
        const p = feature.properties || {};
        layer.bindPopup(regionPopupHTML(p), { maxWidth: 360 });
        layer.on('mouseover', () => layer.setStyle({ weight: 2 }));
        layer.on('mouseout', () => layer.setStyle({ weight: 1 }));
      }
    }).addTo(map);

    // Points
    const pointsLayer = L.geoJSON(points, {
      pointToLayer: (feature, latlng) => L.circleMarker(latlng, { radius: 6, weight: 1, fillOpacity: 0.75 }),
      onEachFeature: (feature, layer) => {
        const p = feature.properties || {};
        const html = `
          <div class="popup">
            <h3>${p.name ?? "Без названия"}</h3>
            <div class="muted">${p.region ?? ""}${p.city ? ", " + p.city : ""}</div>
            <div>${p.address ?? ""}</div>
            <div style="margin-top:8px;"><b>Девочек:</b> ${fmt.format(p.girls_total ?? 0)}</div>
            ${p.phone ? `<div><b>Тел:</b> ${p.phone}</div>` : ""}
            ${p.email ? `<div><b>Email:</b> ${p.email}</div>` : ""}
          </div>
        `;
        layer.bindPopup(html, { maxWidth: 360 });
      }
    });

    cluster.addLayer(pointsLayer);
    map.addLayer(cluster);

    map.fitBounds(regionsLayer.getBounds().pad(0.1));

    // Legend
    const legend = L.control({position: 'bottomleft'});
    legend.onAdd = function() {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <div style="font-weight:700; margin-bottom:6px;">Заливка: девочек в регионе</div>
        <div class="row"><span class="swatch" style="background:#eff6ff"></span> 0</div>
        <div class="row"><span class="swatch" style="background:#dbeafe"></span> 1–50</div>
        <div class="row"><span class="swatch" style="background:#bfdbfe"></span> 51–150</div>
        <div class="row"><span class="swatch" style="background:#93c5fd"></span> 151–300</div>
        <div class="row"><span class="swatch" style="background:#60a5fa"></span> 301–700</div>
        <div class="row"><span class="swatch" style="background:#3b82f6"></span> 701+</div>
      `;
      return div;
    };
    legend.addTo(map);

    // --- Superleague: highlight regions + show clubs in region popup ---
    const superCheckbox = document.getElementById('toggleSuperleague');

    fetchJSON('./data/superleague_clubs.json')
      .then(sl => {
        const statusEl = document.getElementById('slStatus');
        const brand = sl.brand || { color: "#d000e0", colorDark: "#501070", logo: "./assets/superleague_logo.png" };

        // нормализуем: регион -> клубы
        const byRegion = {};
        const src = sl.by_region || {};
        for (const [rName, clubs] of Object.entries(src)) {
          byRegion[normRegion(rName)] = (clubs || []).filter(Boolean);
        }
        // считаем, сколько регионов GeoJSON совпало со списком
const geoRegions = new Set();
regionsLayer.eachLayer(layer => {
  const p = layer.feature?.properties || {};
  geoRegions.add(normRegion(p.name));
});

const byRegionKeys = Object.keys(byRegion);
const matched = byRegionKeys.filter(k => geoRegions.has(k)).length;

if (statusEl) {
  statusEl.textContent = `(клубов в JSON: ${byRegionKeys.length} регионов, совпало: ${matched})`;
}

        function regionPopupWithSuperleague(p) {
          const base = regionPopupHTML(p);
          const clubs = byRegion[normRegion(p.name)] || [];
          if (!superCheckbox.checked || clubs.length === 0) return base;

          const extra = `
            <div style="margin-top:10px; padding-top:10px; border-top:1px solid #eee;">
              <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                <img src="${brand.logo}" alt="Суперлига" style="width:18px; height:18px; object-fit:contain;">
                <b style="color:${brand.color}">Суперлига</b>
              </div>
              <div style="margin-top:4px; line-height:1.35;">
                ${clubs.map(c => `• ${c}`).join("<br>")}
              </div>
            </div>
          `;
          // вставляем extra перед закрывающим </div> в попапе
          return base.replace("</div>", extra + "</div>");
        }

        function applySuperleague(isOn) {
          regionsLayer.eachLayer(layer => {
            const p = layer.feature?.properties || {};
            const clubs = byRegion[normRegion(p.name)] || [];
            const hasClubs = clubs.length > 0;

            // обновляем попап (чтобы список появлялся/исчезал)
            layer.bindPopup(regionPopupWithSuperleague(p), { maxWidth: 360 });

            if (isOn && hasClubs) {
              layer.setStyle({ color: brand.color, weight: 3, fillOpacity: 0.68 });
              layer.bringToFront();
            } else {
              layer.setStyle(styleRegion(layer.feature));
            }
          });
        }

        superCheckbox.addEventListener('change', () => applySuperleague(superCheckbox.checked));
        applySuperleague(superCheckbox.checked);
      })
      .catch(e => {
  console.error("Superleague overlay failed:", e);
  const statusEl = document.getElementById('slStatus');
  if (statusEl) statusEl.textContent = '(ошибка загрузки данных)';
});

    // если всё ок, прячем панель ошибок
    errBox.style.display = 'none';
  })
  .catch(err => {
    showErr('Ошибка загрузки данных', err);
  });

})();
</script>
</body>
</html>


